<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡åœ’å°å·¥å…· - å®Œç¾æ¼”ç¤ºç‰ˆ</title>
    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; --success: #28a745; --danger: #ff3b30; --warning: #ff9500; --purple: #5856D6; }
        body { background: #e5e5e5; display: flex; justify-content: center; padding: 20px; font-family: -apple-system, sans-serif; margin: 0; }
        
        .phone-container {
            width: 450px; height: 800px; background: white;
            border: 14px solid #333; border-radius: 50px;
            position: relative; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }

        /* å´é‚Šé¸å–® (å¢åŠ  overflow-y ç¢ºä¿å°è¢å¹•ä¹Ÿèƒ½æ»‘å‹•çœ‹åˆ°åº•éƒ¨æŒ‰éˆ•) */
        .side-menu {
            position: absolute; top: 0; left: -300px; width: 300px; height: 100%;
            background: #fff; z-index: 200; transition: 0.3s; box-shadow: 2px 0 15px rgba(0,0,0,0.1);
            padding-top: 80px; display: flex; flex-direction: column;
            overflow-y: auto; /* é—œéµä¿®æ”¹ */
        }
        .side-menu.active { left: 0; }
        .menu-item { padding: 20px 30px; border-bottom: 1px solid #f5f5f5; cursor: pointer; color: #333; font-size: 16px; transition: 0.2s; flex-shrink: 0; }
        .menu-item:hover { background: #f9f9f9; color: var(--primary); }
        
        /* é‡ç½®æŒ‰éˆ•åœ¨é¸å–®ä¸­çš„æ¨£å¼ */
        .menu-item-reset { color: var(--danger); font-weight: bold; border-top: 5px solid #f5f5f5; margin-top: auto; }

        .menu-btn {
            position: absolute; top: 30px; left: 30px; z-index: 210;
            font-size: 24px; cursor: pointer; background: white; border-radius: 50%;
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .content { height: 100%; padding: 30px; box-sizing: border-box; overflow-y: auto; background: var(--bg); scrollbar-width: none; }
        .content::-webkit-scrollbar { display: none; }
        .hidden { display: none !important; }

        /* æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡† */
        .btn-main { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 15px; }
        .form-box { margin-top: 100px; text-align: center; }
        .form-box input, .form-box select { width: 90%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; outline: none; }
        .link-text { color: var(--primary); margin-top: 25px; cursor: pointer; display: inline-block; }

        /* å­¸ç”Ÿç«¯é¡¯ç¤ºå€å¡Š */
        .todo-header { margin-top: 60px; margin-bottom: 10px; color: #333; font-size: 28px; font-weight: 800; }
        .section-title { font-size: 13px; color: #888; margin: 30px 0 10px 0; font-weight: 700; text-transform: uppercase; }
        
        .todo-card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border-left: 6px solid #ddd; display: flex; flex-direction: column; gap: 6px; cursor: pointer; }
        .todo-tag { font-size: 11px; font-weight: 800; text-transform: uppercase; padding: 4px 8px; border-radius: 6px; width: fit-content; color: white; }
        .todo-title { font-size: 17px; font-weight: 700; color: #333; margin-top: 4px; }
        .todo-time { font-size: 13px; color: var(--primary); margin-top: 4px; font-weight: 500; }
        
        .expired-card { opacity: 0.6; filter: grayscale(100%); background: #f9f9f9; box-shadow: none; }
        .unread-title { color: var(--danger) !important; }
        .unread-badge { background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; vertical-align: middle; margin-left: 8px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* æ•™å¸«ç«¯èˆ‡å…¶ä»– */
        .class-card { background: white; padding: 25px 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); cursor: pointer; border-left: 6px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .control-panel { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .control-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .history-chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .history-chip { background: #eef2ff; color: var(--primary); padding: 6px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; border: 1px solid #dbeafe; }
        
        .student-row { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; }
        .grade-input { width: 70px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; font-size: 16px; }

        /* æˆç¸¾å–®èˆ‡èª²è¡¨ */
        .report-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .report-header { background: var(--primary); color: white; padding: 18px 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-size: 16px; }
        .report-body { padding: 15px 20px; }
        .report-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 12px 0; font-size: 15px; color: #333; }
        .report-row:last-child { border-bottom: none; }
        .tag { font-size: 11px; padding: 3px 8px; border-radius: 6px; background: #f0f0f0; color: #666; margin-left: 8px; }
        
        .timetable { width: 100%; border-collapse: separate; border-spacing: 3px; background: white; font-size: 12px; table-layout: fixed; margin-bottom: 40px; }
        .timetable th, .timetable td { border: none; text-align: center; height: 70px; vertical-align: middle; }
        .timetable th { background: #f8f8f8; color: #888; font-weight: bold; border-radius: 8px; height: 40px; }
        .course-cell { width: 100%; height: 100%; border-radius: 10px; padding: 6px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; line-height: 1.4; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .room-text { font-size: 10px; font-weight: normal; opacity: 0.8; margin-top: 3px; }
    </style>
</head>
<body>

<div class="phone-container">
    <div id="ui-menu-btn" class="menu-btn hidden" onclick="toggleMenu()">â˜°</div>
    <div id="ui-side-menu" class="side-menu"></div>

    <div id="page-login" class="content">
        <div class="form-box">
            <h2 style="font-size:28px; font-weight:bold; color:#333; margin-bottom:30px;">å¸³è™Ÿç™»å…¥</h2>
            <input type="text" id="login-user" placeholder="å¸³è™Ÿ">
            <input type="password" id="login-pass" placeholder="å¯†ç¢¼">
            <button class="btn-main" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
            <div class="link-text" onclick="showReg()">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿå‰å¾€è¨»å†Š</div>
            
            <div style="margin-top:50px; padding:15px; background:#f0f0f0; border-radius:12px; text-align:left;">
                <p style="font-size:12px; color:#666; margin:0 0 5px 0;">æ¸¬è©¦å¸³è™Ÿï¼š</p>
                <div style="font-weight:bold;">å­¸ç”Ÿï¼štest / test</div>
                <div style="font-weight:bold;">æ•™å¸«ï¼šteacher / teacher</div>
            </div>

            <div style="margin-top:20px; color:#ccc; font-size:12px; cursor:pointer;" onclick="forceReset()">
                ç³»çµ±ç•°å¸¸ï¼Ÿé»æ­¤é‡ç½®è³‡æ–™
            </div>
        </div>
    </div>

    <div id="page-register" class="content hidden">
        <div class="form-box">
            <h2>å‰µç«‹å¸³è™Ÿ</h2>
            <input type="text" id="reg-user" placeholder="è¨­å®šå¸³è™Ÿ">
            <input type="password" id="reg-pass" placeholder="è¨­å®šå¯†ç¢¼">
            <select id="reg-role">
                <option value="student">èº«ä»½ï¼šå­¸ç”Ÿ</option>
                <option value="teacher">èº«ä»½ï¼šè€å¸«</option>
            </select>
            <button class="btn-main" style="background:var(--success);" onclick="handleRegister()">å®Œæˆè¨»å†Š</button>
            <div class="link-text" onclick="showLogin()">è¿”å›ç™»å…¥</div>
        </div>
    </div>

    <div id="student-dashboard" class="content hidden">
        <h2 class="todo-header">ğŸ‘‹ æ—©å®‰ï¼ŒåŒå­¸ï¼</h2>
        <div class="section-title">âš¡ æ¥ä¸‹ä¾†è¦æ³¨æ„</div>
        <div id="upcoming-list"></div>
        <div class="section-title">ğŸ å·²éæœŸ / æ­·å²ç´€éŒ„</div>
        <div id="history-list"></div>
    </div>

    <div id="student-timetable" class="content hidden">
        <h3 style="margin-top:50px; text-align:center; font-size:22px; color:#333; margin-bottom:20px;">113å­¸å¹´åº¦ èª²è¡¨</h3>
        <table class="timetable"><thead id="th"></thead><tbody id="timetable-body"></tbody></table>
    </div>

    <div id="student-grades" class="content hidden">
        <h3 style="margin-top:50px; font-size:22px; margin-bottom:20px;">æˆç¸¾æŸ¥è©¢</h3>
        <div id="official-report"></div>
    </div>

    <div id="teacher-dashboard" class="content hidden">
        <h2 style="margin-top:60px; margin-bottom:20px;">ğŸ‘¨â€ğŸ« æˆ‘çš„èª²ç¨‹</h2>
        <div id="teacher-class-list"></div>
    </div>

    <div id="teacher-actions" class="content hidden">
        <div style="margin-top:50px; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 id="action-title" style="margin:0;">è³‡æ–™çµæ§‹</h3>
            <button onclick="switchPage('teacher-dashboard')" style="padding:8px 15px; border:none; background:#e0e0e0; color:#333; border-radius:8px; cursor:pointer;">è¿”å›</button>
        </div>
        <div class="class-card" onclick="goToGrading()">
            <span style="font-weight:bold; font-size:18px;">ğŸ“ è¼¸å…¥æˆç¸¾</span>
            <span style="font-size:24px; opacity:0.3;">ğŸ‘‰</span>
        </div>
        <div class="class-card" style="border-left-color: var(--purple);" onclick="goToAnnouncement()">
            <span style="font-weight:bold; font-size:18px;">ğŸ“¢ ç™¼å¸ƒå…¬å‘Š</span>
            <span style="font-size:24px; opacity:0.3;">ğŸ‘‰</span>
        </div>
    </div>

    <div id="teacher-grading" class="content hidden">
        <div style="margin-top:50px; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="grading-title" style="margin:0;">æˆç¸¾è¼¸å…¥</h3>
            <button onclick="switchPage('teacher-actions')" style="padding:8px 15px; border:none; background:#e0e0e0; color:#333; border-radius:8px; cursor:pointer;">è¿”å›</button>
        </div>
        <div class="control-panel" style="border-left:5px solid var(--success);">
            <h4 style="margin:0 0 10px 0;">â• æ–°å¢è©•åˆ†é …ç›®</h4>
            <div class="control-row">
                <input type="text" id="new-item-name" placeholder="åç¨± (ä¾‹:å°è€ƒ1)">
                <input type="number" id="new-item-weight" placeholder="æ¬Šé‡%" style="width:70px;">
            </div>
            <button class="btn-main" style="margin-top:0; font-size:14px; background:var(--success);" onclick="addAssessmentItem()">å»ºç«‹é …ç›®</button>
        </div>
        <div class="control-panel" style="border-left:5px solid var(--primary);">
            <h4 style="margin:0 0 10px 0;">ğŸ“ è¼¸å…¥åˆ†æ•¸</h4>
            <select id="assessment-select" onchange="renderGradingList()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:16px;">
                <option value="">-- è«‹é¸æ“‡ --</option>
            </select>
        </div>
        <div id="grading-list-area"></div>
    </div>

    <div id="teacher-announcement" class="content hidden">
        <div style="margin-top:50px; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">ç™¼å¸ƒå…¬å‘Š</h3>
            <button onclick="switchPage('teacher-actions')" style="padding:8px 15px; border:none; background:#e0e0e0; color:#333; border-radius:8px; cursor:pointer;">è¿”å›</button>
        </div>
        <div class="control-panel" style="border-left:5px solid var(--purple);">
            <h4 style="margin:0 0 15px 0;">è¨­å®šé€šçŸ¥å…§å®¹</h4>
            <p style="margin-bottom:8px; font-weight:bold; font-size:13px; color:#666;">å¸¸ç”¨ç¯„æœ¬</p>
            <div id="history-chips-area" class="history-chip-container"></div>
            
            <p style="margin-bottom:5px; font-weight:bold;">å…¬å‘Šæ¨™é¡Œ</p>
            <input type="text" id="anc-type" placeholder="ä¾‹å¦‚ï¼šèª¿èª²é€šçŸ¥" style="width:90%; margin-bottom:15px;">

            <p style="margin-bottom:5px; font-weight:bold;">æ™‚é–“ (æ—¥æœŸèˆ‡æ™‚åˆ»)</p>
            <input type="datetime-local" id="anc-date" style="width:90%; padding:12px; border:1px solid #ddd; border-radius:8px; margin-bottom:15px; font-family:inherit;">

            <p style="margin-bottom:5px; font-weight:bold;">è©³ç´°èªªæ˜</p>
            <input type="text" id="anc-detail" placeholder="ä¾‹å¦‚ï¼šæ”¹è‡³ E202 ä¸Šèª²" style="width:90%;">
            <button class="btn-main" style="background:var(--purple);" onclick="publishAnnouncement()">ç™¼é€é€šçŸ¥</button>
        </div>
    </div>
</div>

<script>
    // --- 1. è³‡æ–™è®Šæ•¸å®£å‘Š ---
    const courses = [
        { day: 1, start: 5, end: 7, name: "çµ±è¨ˆå­¸(ä¸€)", room: "E212", color: "#e3f2fd", text: "#1565c0" },
        { day: 2, start: 2, end: 4, name: "é›»å•†å®‰å…¨", room: "C220", color: "#ffebee", text: "#c62828" },
        { day: 2, start: 5, end: 6, name: "é‹å‹•ä¼‘é–’", room: "E010", color: "#e8f5e9", text: "#2e7d32" },
        { day: 3, start: 2, end: 4, name: "é†«ç™‚è³‡è¨Š", room: "E212", color: "#f3e5f5", text: "#6a1b9a" },
        { day: 4, start: 3, end: 4, name: "Pythonåˆ†æ", room: "B211", color: "#fff3e0", text: "#ef6c00" },
        { day: 4, start: 5, end: 7, name: "å•†æ¥­åˆ†æ", room: "C220", color: "#e0f7fa", text: "#006064" },
        { day: 5, start: 1, end: 2, name: "å¯¦ç”¨è‹±æ–‡", room: "E301", color: "#fce4ec", text: "#880e4f" },
        { day: 5, start: 5, end: 7, name: "è³‡æ–™çµæ§‹", room: "E006", color: "#fff8e1", text: "#ff6f00" } 
    ];

    const teacherClassesList = [
        { name: "è³‡æ–™çµæ§‹(ç”²ç­)", short: "è³‡æ–™çµæ§‹" },
        { name: "è³‡æ–™çµæ§‹(ä¹™ç­)", short: "è³‡æ–™çµæ§‹" },
        { name: "å¾®ç©åˆ†(ç”²ç­)", short: "å¾®ç©åˆ†" },
        { name: "å¾®ç©åˆ†(ä¹™ç­)", short: "å¾®ç©åˆ†" }
    ];

    const students = ["ç‹å°æ˜", "æå¤§è¯", "é™³é›…å©·", "å¼µå¿—è±ª"];
    let dbClasses = {};
    let dbScores = {};
    let dbAnnouncements = [];
    let dbAncHistory = [];
    let studentReadHistory = [];
    let currentClassFull = "";
    let currentSubject = "";

    // --- 2. ç³»çµ±åˆå§‹åŒ– (ç¢ºä¿è³‡æ–™å­˜åœ¨) ---
    function loadDatabase() {
        const rawClasses = localStorage.getItem('dbClasses');
        if(rawClasses) {
            dbClasses = JSON.parse(rawClasses);
            dbScores = JSON.parse(localStorage.getItem('dbScores')) || {};
            dbAnnouncements = JSON.parse(localStorage.getItem('dbAnnouncements')) || [];
            dbAncHistory = JSON.parse(localStorage.getItem('dbAncHistory')) || ["èª¿èª²é€šçŸ¥", "æ›æ•™å®¤é€šçŸ¥"];
            studentReadHistory = JSON.parse(localStorage.getItem('studentReadHistory')) || [];
        } else {
            forceGenerateData();
        }
    }

    function forceGenerateData() {
        const templates = {
            standard: [{name: "å¹³æ™‚æˆç¸¾", weight: 30}, {name: "æœŸä¸­è€ƒ", weight: 30}, {name: "æœŸæœ«è€ƒ", weight: 40}],
            project: [{name: "å¹³æ™‚æˆç¸¾", weight: 20}, {name: "æœŸä¸­å ±å‘Š", weight: 25}, {name: "æœŸä¸­è€ƒ", weight: 25}, {name: "æœŸæœ«è€ƒ", weight: 30}],
            quizHeavy: [{name: "å¹³æ™‚æˆç¸¾", weight: 20}, {name: "å°è€ƒ1", weight: 10}, {name: "å°è€ƒ2", weight: 10}, {name: "æœŸä¸­è€ƒ", weight: 25}, {name: "æœŸæœ«è€ƒ", weight: 35}]
        };
        const subjectMap = { "é›»å•†å®‰å…¨": "project", "è³‡æ–™çµæ§‹": "quizHeavy", "å•†æ¥­åˆ†æ": "project" };

        dbClasses = {};
        dbScores = {};

        courses.forEach(c => {
            const type = subjectMap[c.name] || "standard";
            if(c.name === "çµ±è¨ˆå­¸(ä¸€)") {
                dbClasses[c.name] = [{name: "å¹³æ™‚æˆç¸¾", weight: 20}, {name: "å°è€ƒ", weight: 20}, {name: "æœŸä¸­å ±å‘Š", weight: 10}, {name: "æœŸä¸­è€ƒ", weight: 20}, {name: "æœŸæœ«è€ƒ", weight: 30}];
            } else {
                dbClasses[c.name] = JSON.parse(JSON.stringify(templates[type]));
            }
            dbScores[c.name] = {};
            students.forEach(stu => {
                dbScores[c.name][stu] = {};
                dbClasses[c.name].forEach(item => {
                    if(c.name==="çµ±è¨ˆå­¸(ä¸€)" && item.name==="æœŸä¸­å ±å‘Š") dbScores[c.name][stu][item.name] = 85;
                    else dbScores[c.name][stu][item.name] = Math.floor(Math.random() * 30) + 70;
                });
            });
        });

        teacherClassesList.forEach(tc => {
            if(!dbClasses[tc.name]) {
                dbClasses[tc.name] = JSON.parse(JSON.stringify(templates["quizHeavy"]));
                dbScores[tc.name] = {};
                students.forEach(stu => dbScores[tc.name][stu] = {});
            }
        });

        dbAnnouncements = [];
        dbAncHistory = ["èª¿èª²é€šçŸ¥", "æ›æ•™å®¤é€šçŸ¥"];
        studentReadHistory = [];
        saveAll();
    }

    function saveAll() {
        localStorage.setItem('dbClasses', JSON.stringify(dbClasses));
        localStorage.setItem('dbScores', JSON.stringify(dbScores));
        localStorage.setItem('dbAnnouncements', JSON.stringify(dbAnnouncements));
        localStorage.setItem('dbAncHistory', JSON.stringify(dbAncHistory));
        localStorage.setItem('studentReadHistory', JSON.stringify(studentReadHistory));
    }

    function forceReset() {
        if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
            localStorage.clear();
            location.reload();
        }
    }

    loadDatabase();

    // --- 3. ä»‹é¢å°èˆª ---
    function showReg() { switchPage('page-register'); }
    function showLogin() { switchPage('page-login'); }
    function handleRegister() { alert("å±•ç¤ºæ¨¡å¼å·²é–å®š"); showLogin(); }

    function handleLogin() {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        if(u==="test" && p==="test") return enterSystem('student');
        if(u==="teacher" && p==="teacher") return enterSystem('teacher');
        alert("å¸³è™ŸéŒ¯èª¤ï¼Œè«‹ä½¿ç”¨é è¨­å¸³è™Ÿ");
    }

    function enterSystem(role) {
        document.getElementById('ui-menu-btn').classList.remove('hidden');
        renderMenu(role);
        if(role === 'student') {
            switchPage('student-dashboard');
            renderStudentDashboard();
            renderTimetable();
            renderStudentGrades();
        } else {
            switchPage('teacher-dashboard');
            renderTeacherClassList();
        }
    }

    function switchPage(id) {
        document.querySelectorAll('.content').forEach(p => p.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.getElementById('ui-side-menu').classList.remove('active');
    }

    function toggleMenu() { document.getElementById('ui-side-menu').classList.toggle('active'); }

    // é‡é»ä¿®æ”¹ï¼šå°‡é‡ç½®æŒ‰éˆ•ç§»å…¥é¸å–®åº•éƒ¨
    function renderMenu(role) {
        const m = document.getElementById('ui-side-menu');
        const items = role === 'student' ? 
            [{n:'ğŸ”” å¾…è¾¦èˆ‡æé†’',p:'student-dashboard'}, {n:'ğŸ“… æˆ‘çš„é€±èª²è¡¨',p:'student-timetable'}, {n:'ğŸ“Š æˆç¸¾æŸ¥è©¢',p:'student-grades'}] :
            [{n:'ğŸ‘¨â€ğŸ« æˆ‘çš„èª²ç¨‹',p:'teacher-dashboard'}];
        
        let h = items.map(i => `<div class="menu-item" onclick="switchPage('${i.p}')">${i.n}</div>`).join('');
        
        // ç™»å‡ºæŒ‰éˆ•
        h += `<div class="menu-item" onclick="location.reload()" style="color:#666;">ğŸšª ç™»å‡ºç³»çµ±</div>`;
        
        // é‡ç½®æŒ‰éˆ• (ç§»åˆ°é€™è£¡)
        h += `<div class="menu-item menu-item-reset" onclick="forceReset()">ğŸ”´ é‡ç½®ç³»çµ±è³‡æ–™</div>`;
        
        m.innerHTML = h;
    }

    // --- 4. å­¸ç”Ÿç«¯é‚è¼¯ ---
    function renderStudentDashboard() {
        const up = document.getElementById('upcoming-list');
        const his = document.getElementById('history-list');
        up.innerHTML = ""; his.innerHTML = "";

        const now = new Date();
        const dateStr = (d, t) => {
            const dt = new Date(now); dt.setDate(dt.getDate()+d);
            return dt.toISOString().split('T')[0] + "T" + t;
        };

        const fixed = [
            { id: 901, type: 'ä½œæ¥­æé†’', title: 'é›»å•†å®‰å…¨ - èª²å¾Œä½œæ¥­', fullDate: dateStr(1,"23:59"), displayDate: 'æ˜æ—¥ 23:59', color: '#007AFF', category: 'todo', detail: 'è«‹ä¸Šå‚³è‡³æ•¸ä½å­¸é™¢' },
            { id: 902, type: 'å ±å‘Šæé†’', title: 'å•†æ¥­åˆ†æ - å°çµ„å ±å‘Š', fullDate: dateStr(3,"13:30"), displayDate: 'é€±å›› 13:30', color: '#ffcc00', category: 'todo', detail: 'æº–å‚™ 10 åˆ†é˜ PPT' },
            { id: 903, type: 'è€ƒè©¦æé†’', title: 'è³‡æ–™çµæ§‹ - æœŸä¸­è€ƒ', fullDate: dateStr(4,"13:30"), displayDate: 'é€±äº” 13:30', color: '#ff3b30', category: 'todo', detail: 'ç¯„åœ: Ch1-Ch5' }
        ];

        const myCourseNames = courses.map(c => c.name);
        const myAnc = dbAnnouncements.filter(a => myCourseNames.includes(a.targetSubject));
        const all = [...fixed, ...myAnc];

        let active = [], expired = [];
        all.forEach(i => (new Date(i.fullDate) < now) ? expired.push(i) : active.push(i));
        
        active.sort((a,b) => new Date(a.fullDate) - new Date(b.fullDate));
        expired.sort((a,b) => new Date(b.fullDate) - new Date(a.fullDate));

        const render = (i, isExp) => {
            let title = i.title, detail = i.detail, badge = "", cls = isExp ? "todo-card expired-card" : "todo-card";
            if(i.category === 'announce') {
                title = i.targetClass;
                if(!isExp && !studentReadHistory.includes(i.id)) {
                    title = `<span class="unread-title">${title}</span>`;
                    badge = `<span class="unread-badge">NEW</span>`;
                }
            }
            const click = (i.category==='announce' && !isExp) ? `onclick="readAnc(${i.id})"` : "";
            const time = i.displayDate || i.fullDate.replace("T"," ");
            const color = i.color || "#5856D6";

            return `<div class="${cls}" style="border-left-color:${color}" ${click}>
                <div style="display:flex;justify-content:space-between;"><div class="todo-tag" style="background:${color};color:${color==='#ffcc00'?'black':'white'}">${i.type}</div>${badge}</div>
                <div class="todo-title">${title}</div>
                <div style="font-size:15px;font-weight:bold;color:#333;margin-top:5px;">${detail}</div>
                <div class="todo-time">ğŸ•’ ${time}</div>
            </div>`;
        };

        if(active.length) active.forEach(i => up.innerHTML += render(i, false));
        else up.innerHTML = `<div style="text-align:center;color:#999;padding:20px;">ç„¡å¾…è¾¦äº‹é …</div>`;
        
        if(expired.length) expired.forEach(i => his.innerHTML += render(i, true));
        else his.innerHTML = `<div style="text-align:center;color:#ccc;padding:20px;">ç„¡ç´€éŒ„</div>`;
    }

    function readAnc(id) {
        if(!studentReadHistory.includes(id)) {
            studentReadHistory.push(id);
            saveAll();
            renderStudentDashboard();
        }
    }

    function renderTimetable() {
        const th = document.getElementById('th');
        const body = document.getElementById('timetable-body');
        th.innerHTML = '<tr><th style="width:40px;">ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr>';
        body.innerHTML = "";
        for(let i=1; i<=7; i++) {
            let r = `<tr><td style="font-weight:bold;color:#888;">${i}</td>`;
            for(let d=1; d<=5; d++) {
                const c = courses.find(x => x.day === d && i >= x.start && i <= x.end);
                r += c ? `<td><div class="course-cell" style="background:${c.color};color:${c.text}"><span>${c.name}</span><span class="room-text">ğŸ“${c.room}</span></div></td>` : `<td></td>`;
            }
            body.innerHTML += r + `</tr>`;
        }
    }

    function renderStudentGrades() {
        const div = document.getElementById('official-report');
        const stu = "ç‹å°æ˜";
        let html = "", hasData = false;
        
        courses.forEach(c => {
            const items = dbClasses[c.name] || [];
            const scores = dbScores[c.name]?.[stu] || {};
            if(items.length) {
                hasData = true;
                let rows = "", total = 0;
                items.forEach(i => {
                    const sc = scores[i.name];
                    const disp = sc ? sc : "-";
                    rows += `<div class="report-row"><span>${i.name} <span class="tag">${i.weight}%</span></span><span style="font-weight:bold;${sc<60?'color:red':''}">${disp}</span></div>`;
                    if(sc) total += parseFloat(sc)*(i.weight/100);
                });
                html += `<div class="report-card"><div class="report-header" style="background:${c.text}"><span>${c.name}</span><span>${total.toFixed(1)} åˆ†</span></div><div class="report-body">${rows}</div></div>`;
            }
        });
        div.innerHTML = hasData ? html : `<div style="text-align:center;padding:30px;color:#888;">ç„¡æˆç¸¾è³‡æ–™</div>`;
    }

    // --- 5. æ•™å¸«ç«¯é‚è¼¯ ---
    function renderTeacherClassList() {
        const list = document.getElementById('teacher-class-list');
        list.innerHTML = "";
        teacherClassesList.forEach(c => {
            let color = c.name.includes("è³‡æ–™çµæ§‹") ? "#fff3e0" : "#e3f2fd";
            let bColor = c.name.includes("è³‡æ–™çµæ§‹") ? "#ff9800" : "#2196f3";
            list.innerHTML += `<div class="class-card" style="background:${color};border-left-color:${bColor}" onclick="selectClass('${c.name}','${c.short}')"><div><div style="font-size:18px;font-weight:bold;">${c.name}</div><div style="font-size:14px;color:#666;margin-top:5px;">è³‡ç®¡ç³»å­¸ç”Ÿ</div></div><span style="font-size:24px;opacity:0.5;">ğŸ‘‰</span></div>`;
        });
    }

    function selectClass(n, s) {
        currentClassFull = n;
        currentSubject = s;
        document.getElementById('action-title').innerText = n;
        switchPage('teacher-actions');
    }

    function goToGrading() {
        document.getElementById('grading-title').innerText = currentClassFull;
        if(!dbClasses[currentClassFull]) dbClasses[currentClassFull] = [];
        if(!dbScores[currentClassFull]) dbScores[currentClassFull] = {};
        students.forEach(s => { if(!dbScores[currentClassFull][s]) dbScores[currentClassFull][s] = {}; });
        
        updateAssessList();
        switchPage('teacher-grading');
        document.getElementById('grading-list-area').innerHTML = '<p style="text-align:center;color:#999;margin-top:30px;">è«‹å…ˆé¸æ“‡é …ç›®</p>';
    }

    function addAssessmentItem() {
        const n = document.getElementById('new-item-name').value;
        const w = parseInt(document.getElementById('new-item-weight').value);
        if(!n || isNaN(w)) return alert("è¼¸å…¥éŒ¯èª¤");
        dbClasses[currentClassFull].push({name:n, weight:w});
        saveAll();
        alert("å·²æ–°å¢");
        updateAssessList();
        document.getElementById('assessment-select').value = n;
        renderGradingList();
    }

    function updateAssessList() {
        const s = document.getElementById('assessment-select');
        s.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
        if(dbClasses[currentClassFull]) dbClasses[currentClassFull].forEach(i => s.innerHTML += `<option value="${i.name}">${i.name} (${i.weight}%)</option>`);
    }

    function renderGradingList() {
        const item = document.getElementById('assessment-select').value;
        const div = document.getElementById('grading-list-area');
        if(!item) { div.innerHTML=""; return; }
        let h = `<h4 style="margin:20px 0 10px 0;">è¼¸å…¥ï¼š${item}</h4>`;
        students.forEach(stu => {
            const sc = dbScores[currentClassFull][stu][item] || "";
            h += `<div class="student-row"><span>${stu}</span><input type="number" class="grade-input" value="${sc}" onchange="saveScore('${stu}','${item}',this.value)"></div>`;
        });
        div.innerHTML = h;
    }

    function saveScore(stu, item, val) {
        dbScores[currentClassFull][stu][item] = val;
        saveAll();
    }

    function goToAnnouncement() {
        const div = document.getElementById('history-chips-area');
        div.innerHTML = "";
        dbAncHistory.forEach(t => div.innerHTML += `<div class="history-chip" onclick="document.getElementById('anc-type').value='${t}'">${t}</div>`);
        document.getElementById('anc-type').value = "";
        document.getElementById('anc-date').value = "";
        document.getElementById('anc-detail').value = "";
        switchPage('teacher-announcement');
    }

    function publishAnnouncement() {
        const t = document.getElementById('anc-type').value;
        const d = document.getElementById('anc-date').value;
        const det = document.getElementById('anc-detail').value;
        if(!t || !d || !det) return alert("è«‹å¡«å¯«å®Œæ•´");
        
        if(!dbAncHistory.includes(t)) { dbAncHistory.push(t); saveAll(); }
        
        const dateObj = new Date(d);
        const display = dateObj.toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' });

        dbAnnouncements.push({
            id: Date.now(),
            targetSubject: currentSubject,
            targetClass: currentClassFull,
            type: t,
            fullDate: d,
            displayDate: display,
            detail: det,
            category: 'announce',
            color: '#5856D6'
        });
        saveAll();
        alert("ç™¼å¸ƒæˆåŠŸ");
        switchPage('teacher-actions');
    }

</script>
</body>
</html>